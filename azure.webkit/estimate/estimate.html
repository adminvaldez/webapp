<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Instant Estimate | VALDEZTECH</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>
<link href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css" rel="stylesheet"/>

<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
body { background:#f4f6f7; padding-top:80px; }
#map { height: 450px; border-radius:8px; }
.result-card { display:none; }
</style>
</head>

<body>

<header>
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="#">VALDEZTECH</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="../services.html">Services</a></li>
        <li class="nav-item"><a class="nav-link" href="../areas.html">Areas We Serve</a></li>
        <li class="nav-item"><a class="nav-link" href="../estimate/qoute.html">Pricing</a></li>
        <li class="nav-item"><a class="nav-link" href="../about.html">About</a></li>
      </ul>
    </div>
  </div>
</nav>
</header>

<div class="container py-5">

<h1 class="mb-4">Draw Your Service Area</h1>

<div class="card p-4 mb-4 shadow-sm">

<label class="form-label fw-semibold">Enter Property Address</label>
<input type="text" id="addressInput" class="form-control mb-3" placeholder="123 Main St Houston TX">

<button class="btn btn-primary mb-3" onclick="geocodeAddress()">Find Address</button>

<p class="small text-muted">
After locating your property, use the draw tool in the top right of the map.
</p>

</div>

<div id="map" class="mb-4 shadow-sm"></div>

<div id="resultCard" class="card p-4 shadow-sm result-card">
<h4>Estimate</h4>
<p><strong>Total Area:</strong> <span id="totalArea"></span> sq ft</p>
<p><strong>Estimated Price:</strong> $<span id="priceEstimate"></span></p>
<p class="small text-muted mt-2">
Final price confirmed after on-site review.
</p>
</div>

</div>

<script>

const subscriptionKey = "PASTE_YOUR_AZURE_MAPS_KEY";

let map;
let dataSource;
let drawingManager;

map = new atlas.Map("map", {
    center: [-95.3698, 29.7604],
    zoom: 11,
    authOptions: {
        authType: "subscriptionKey",
        subscriptionKey: subscriptionKey
    }
});

map.events.add("ready", function () {

    dataSource = new atlas.source.DataSource();
    map.sources.add(dataSource);

    map.layers.add(new atlas.layer.PolygonLayer(dataSource, null, {
        fillColor: "#00AA55",
        fillOpacity: 0.4,
        strokeColor: "#007733",
        strokeWidth: 2
    }));

    // Built-in drawing manager (stable + clean)
    drawingManager = new atlas.drawing.DrawingManager(map, {
        source: dataSource,
        toolbar: new atlas.control.DrawingToolbar({
            position: 'top-right'
        })
    });

    map.events.add('drawingcomplete', drawingManager, calculateEstimate);
});

async function geocodeAddress() {

    const address = document.getElementById("addressInput").value.trim();

    if (!address) {
        alert("Enter an address.");
        return;
    }

    const response = await fetch(
        `https://atlas.microsoft.com/search/address/json?api-version=1.0&subscription-key=${subscriptionKey}&query=${encodeURIComponent(address)}`
    );

    const data = await response.json();

    if (!data.results.length) {
        alert("Address not found.");
        return;
    }

    const pos = data.results[0].position;

    map.setCamera({
        center: [pos.lon, pos.lat],
        zoom: 18
    });
}

function calculateEstimate() {

    const shapes = dataSource.getShapes();

    if (!shapes.length) return;

    let totalArea = 0;

    shapes.forEach(shape => {
        const geojson = shape.toJson();
        const areaSqMeters = turf.area(geojson);
        totalArea += areaSqMeters;
    });

    const areaSqFt = totalArea * 10.7639;

    const ratePerSqFt = 0.20;
    const price = (areaSqFt * ratePerSqFt).toFixed(2);

    document.getElementById("totalArea").innerText = areaSqFt.toFixed(0);
    document.getElementById("priceEstimate").innerText = price;
    document.getElementById("resultCard").style.display = "block";
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
